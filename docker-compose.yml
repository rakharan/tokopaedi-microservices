version: '3.8'

services:
  # ============================================
  # Infrastructure Services
  # ============================================
  
  # RabbitMQ - Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: tokopaedi-rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Cache
  redis:
    image: redis:7-alpine
    container_name: tokopaedi-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Database Services (One per microservice)
  # ============================================
  
  # User Service Database
  user-db:
    image: mysql:8.0
    container_name: tokopaedi-user-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: user_db
      MYSQL_USER: user_service
      MYSQL_PASSWORD: user_pass
    ports:
      - "3307:3306"
    volumes:
      - user_db_data:/var/lib/mysql
      - ./infrastructure/mysql/user-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Product Service Database
  product-db:
    image: mysql:8.0
    container_name: tokopaedi-product-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: product_db
      MYSQL_USER: product_service
      MYSQL_PASSWORD: product_pass
    ports:
      - "3308:3306"
    volumes:
      - product_db_data:/var/lib/mysql
      - ./infrastructure/mysql/product-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Order Service Database
  order-db:
    image: mysql:8.0
    container_name: tokopaedi-order-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: order_db
      MYSQL_USER: order_service
      MYSQL_PASSWORD: order_pass
    ports:
      - "3309:3306"
    volumes:
      - order_db_data:/var/lib/mysql
      - ./infrastructure/mysql/order-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Payment Service Database
  payment-db:
    image: mysql:8.0
    container_name: tokopaedi-payment-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: payment_db
      MYSQL_USER: payment_service
      MYSQL_PASSWORD: payment_pass
    ports:
      - "3310:3306"
    volumes:
      - payment_db_data:/var/lib/mysql
      - ./infrastructure/mysql/payment-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Delivery Service Database
  delivery-db:
    image: mysql:8.0
    container_name: tokopaedi-delivery-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: delivery_db
      MYSQL_USER: delivery_service
      MYSQL_PASSWORD: delivery_pass
    ports:
      - "3311:3306"
    volumes:
      - delivery_db_data:/var/lib/mysql
      - ./infrastructure/mysql/delivery-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Notification Service Database
  notification-db:
    image: mysql:8.0
    container_name: tokopaedi-notification-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: notification_db
      MYSQL_USER: notification_service
      MYSQL_PASSWORD: notification_pass
    ports:
      - "3312:3306"
    volumes:
      - notification_db_data:/var/lib/mysql
      - ./infrastructure/mysql/notification-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - tokopaedi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Microservices
  # ============================================

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: tokopaedi-gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      ORDER_SERVICE_URL: http://order-service:3003
      PAYMENT_SERVICE_URL: http://payment-service:3004
      DELIVERY_SERVICE_URL: http://delivery-service:3005
      NOTIFICATION_SERVICE_URL: http://notification-service:3006
      REDIS_URL: redis://redis:6379
    depends_on:
      - redis
      - user-service
      - product-service
      - order-service
    networks:
      - tokopaedi-network
    volumes:
      - ./api-gateway:/app
      - /app/node_modules
    command: npm run dev

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: tokopaedi-user-service
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      DB_HOST: user-db
      DB_PORT: 3306
      DB_NAME: user_db
      DB_USER: user_service
      DB_PASSWORD: user_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your-secret-key-change-in-production
    depends_on:
      user-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/user-service:/app
      - /app/node_modules
    command: npm run dev

  # Product Service
  product-service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    container_name: tokopaedi-product-service
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      DB_HOST: product-db
      DB_PORT: 3306
      DB_NAME: product_db
      DB_USER: product_service
      DB_PASSWORD: product_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
    depends_on:
      product-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/product-service:/app
      - /app/node_modules
    command: npm run dev

  # Order Service
  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: tokopaedi-order-service
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: development
      PORT: 3003
      DB_HOST: order-db
      DB_PORT: 3306
      DB_NAME: order_db
      DB_USER: order_service
      DB_PASSWORD: order_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
    depends_on:
      order-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/order-service:/app
      - /app/node_modules
    command: npm run dev

  # Payment Service
  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: tokopaedi-payment-service
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: development
      PORT: 3004
      DB_HOST: payment-db
      DB_PORT: 3306
      DB_NAME: payment_db
      DB_USER: payment_service
      DB_PASSWORD: payment_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
      # Payment Gateway Credentials (use test/sandbox)
      MIDTRANS_SERVER_KEY: your-midtrans-sandbox-key
      MIDTRANS_CLIENT_KEY: your-midtrans-sandbox-client
    depends_on:
      payment-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/payment-service:/app
      - /app/node_modules
    command: npm run dev

  # Delivery Service
  delivery-service:
    build:
      context: ./services/delivery-service
      dockerfile: Dockerfile
    container_name: tokopaedi-delivery-service
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: development
      PORT: 3005
      DB_HOST: delivery-db
      DB_PORT: 3306
      DB_NAME: delivery_db
      DB_USER: delivery_service
      DB_PASSWORD: delivery_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
    depends_on:
      delivery-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/delivery-service:/app
      - /app/node_modules
    command: npm run dev

  # Notification Service
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: tokopaedi-notification-service
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: development
      PORT: 3006
      DB_HOST: notification-db
      DB_PORT: 3306
      DB_NAME: notification_db
      DB_USER: notification_service
      DB_PASSWORD: notification_pass
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      REDIS_URL: redis://redis:6379
      # Email Configuration
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: your-email@gmail.com
      SMTP_PASS: your-app-password
    depends_on:
      notification-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tokopaedi-network
    volumes:
      - ./services/notification-service:/app
      - /app/node_modules
    command: npm run dev

  # ============================================
  # Monitoring Stack (Optional - for production)
  # ============================================

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: tokopaedi-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - tokopaedi-network
    profiles:
      - monitoring

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: tokopaedi-grafana
    ports:
      - "3100:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - ./infrastructure/monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./infrastructure/monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - tokopaedi-network
    profiles:
      - monitoring

# ============================================
# Networks
# ============================================
networks:
  tokopaedi-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  rabbitmq_data:
  redis_data:
  user_db_data:
  product_db_data:
  order_db_data:
  payment_db_data:
  delivery_db_data:
  notification_db_data:
  prometheus_data:
  grafana_data:
